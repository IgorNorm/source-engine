# Build Episodic on macOS Intel (amd64)
# Use runs-on: macos-15-intel to ensure Intel image is selected.

name: Build Episodic macOS AMD64 (Native)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-15-intel
    timeout-minutes: 90

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Ensure Xcode CLI tools
        run: |
          if ! xcode-select -p >/dev/null 2>&1; then
            echo "Installing Xcode CLI tools..."
            xcode-select --install || true
            # Wait a bit if initiated interactively (best-effort)
            sleep 10
          else
            echo "Xcode CLI tools present"
          fi

      - name: Install Homebrew dependencies
        run: |
          set -e
          echo "Updating Homebrew..."
          brew update || true

          echo "Installing packages..."
          # Adjust formula names if any are unavailable; install minimal set required by the project
          brew install pkg-config python@3 sdl2 openal-soft jpeg libpng libtiff webp freetype fontconfig curl bzip2

          # Ensure python3 is on PATH
          if ! command -v python3 >/dev/null; then
            echo "python3 not found after brew install"
            exit 1
          fi
          python3 --version

      - name: Environment setup for build
        run: |
          set -e
          export CC=clang
          export CXX=clang++
          export MACOSX_DEPLOYMENT_TARGET=10.15
          echo "CC=$CC CXX=$CXX MACOSX_DEPLOYMENT_TARGET=$MACOSX_DEPLOYMENT_TARGET"

      - name: Configure (waf)
        run: |
          set -e
          python3 waf configure -T release --build-games=episodic --disable-warns

      - name: Build (waf)
        run: |
          set -e
          python3 waf build -p

      - name: Prepare and Package macOS build artifacts
        run: |
          set -e
          mkdir -p out

          echo "Collecting build artifacts..."
          # Copy executables and macOS libraries (.dylib, .framework), also any .so if present
          find build -type f \( -perm -111 -o -name "*.dylib" -o -name "*.framework" -o -name "*.so" \) -print0 \
            | xargs -0 -I {} bash -c 'f="{}"; echo "Copying $f"; dest="out/$(dirname "${f#./build/}")"; mkdir -p "$dest"; cp -R "$f" "$dest/"'

          # Copy project data/assets if present (adjust paths as needed)
          if [ -d "game" ]; then
            echo "Copying game assets..."
            cp -R game out/ || true
          fi

          echo "Out contents:"
          find out -maxdepth 5 -print || true

          TAR_NAME="episodic_macos_amd64.tar.gz"
          tar -czvf "$TAR_NAME" out
          echo "Packaged: $TAR_NAME"
          echo "tar_name=$TAR_NAME" >> "$GITHUB_OUTPUT"

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: Episodic-macos-amd64
          path: episodic_macos_amd64.tar.gz
