name: Build Portal Source Engine - ARM64 Windows Edition

on: 
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-2022

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'

      - name: Download SDL2
        run: |
          curl -L https://github.com/libsdl-org/SDL/releases/download/release-2.28.5/SDL2-devel-2.28.5-VC.zip -o sdl2.zip
          Expand-Archive sdl2.zip -DestinationPath .
          if (Test-Path "SDL2-2.28.5") { Rename-Item "SDL2-2.28.5" "SDL2" }

      - name: Configure and Build
        shell: cmd
        run: |
          :: 1. Ініціалізуємо MSVC для ARM64
          :: Використовуємо шлях для Visual Studio 2022, оскільки вона стабільніша для ARM
          call "C:\Program Files\Microsoft Visual Studio\2022\Enterprise\VC\Auxiliary\Build\vcvarsamd64_arm64.bat"
          
          :: 2. Очищення
          if exist build rd /s /q build
          
          :: 3. КОНФІГУРАЦІЯ ПІД ARM64
          :: Примусово вказуємо використовувати MSVC (cl.exe), щоб ігнорувати MinGW/GCC
          set CC=cl.exe
          set CXX=cl.exe
          
          :: Вказуємо параметри конфігурації
          python waf configure -T release --build-games=portal --sdl2=SDL2 --msvc_targets="arm64" --msvc_version="msvc 17.0"
          
          if %ERRORLEVEL% NEQ 0 (
            echo --- CONFIG FAILED. LOG: ---
            if exist build\config.log type build\config.log
            exit /b 1
          )

          :: 4. ПОВНА ЗБІРКА (Двигун + Гра + EXE)
          python waf build -p

      - name: Prepare Full ARM64 Package
        shell: powershell
        run: |
          $DestDir = "portal_arm64_full"
          if (Test-Path $DestDir) { Remove-Item -Recurse -Force $DestDir }
          New-Item -ItemType Directory -Force -Path $DestDir
          
          # Копіюємо всі EXE та DLL з папки build
          Get-ChildItem -Path "build" -Include @("*.exe", "*.dll") -Recurse | Copy-Item -Destination $DestDir -Force
          
          Write-Host "--- Пакет ARM64 підготовлено ---"
          Get-ChildItem -Path $DestDir

      - name: Upload ARM64 Build
        uses: actions/upload-artifact@v4
        with:
          name: Portal-WoA-ARM64-Full
          path: portal_arm64_full/
          
