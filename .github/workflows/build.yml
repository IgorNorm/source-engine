name: Debug Waf Scripts

on: 
  workflow_dispatch:

jobs:
  debug-build:
    runs-on: windows-2019

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Show me the Wscript
        # Цей крок виведе вміст головного скрипта, щоб я зрозумів, чому він не бачить MSVC
        shell: powershell
        run: |
          Write-Host "--- START OF WSCRIPT ---"
          if (Test-Path "wscript") { Get-Content "wscript" -Head 100 }
          Write-Host "--- END OF WSCRIPT ---"

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'

      - name: Configure and Build (Emergency Mode)
        shell: cmd
        env:
          CL: /DTIER0_DLL_EXPORT /DVSTDLIB_DLL_EXPORT /D_WINDOWS /DWIN32 /D_CRT_SECURE_NO_WARNINGS
          LINK: /SUBSYSTEM:WINDOWS,10.0
        run: |
          call "C:\Program Files (x86)\Microsoft Visual Studio\2019\Enterprise\VC\Auxiliary\Build\vcvars64.bat"
          
          :: СПРОБА №1: Видаляємо папку MinGW з шляхів зовсім
          set PATH=%PATH:C:\mingw64\bin;=%
          
          :: СПРОБА №2: Примушуємо Waf завантажити msvc через прапорець load
          python waf configure -T release --build-games=hl2 --sdl2=SDL2 --check-c-compiler=msvc --check-cxx-compiler=msvc
          
          if %ERRORLEVEL% NEQ 0 (
            echo CONFIG FAILED, PRINTING CONFIG.LOG...
            type build\config.log
          )
