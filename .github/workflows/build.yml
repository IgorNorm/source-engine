name: Build Source Engine - Full Artifact Fix

on: 
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-2019

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'

      - name: Download SDL2
        run: |
          curl -L https://github.com/libsdl-org/SDL/releases/download/release-2.28.5/SDL2-devel-2.28.5-VC.zip -o sdl2.zip
          Expand-Archive sdl2.zip -DestinationPath .
          if (Test-Path "SDL2-2.28.5") { Rename-Item "SDL2-2.28.5" "SDL2" }

      - name: Configure and Build
        shell: cmd
        run: |
          :: 1. Ініціалізація MSVC 2019
          call "C:\Program Files (x86)\Microsoft Visual Studio\2019\Enterprise\VC\Auxiliary\Build\vcvars64.bat"
          
          :: 2. Чиста папка build
          if exist build rd /s /q build
          
          :: 3. КОНФІГУРАЦІЯ (без прапорців CFLAGS)
          :: Це дозволяє пройти тест "Testing 64bit support"
          python waf configure -T release --build-games=hl2 --sdl2=SDL2 --msvc_targets="x64"
          
          if %ERRORLEVEL% NEQ 0 (
            echo --- CONFIG FAILED ---
            type build\config.log
            exit /b 1
          )

          :: 4. ЗБІРКА (з прапорцями для виправлення Tier0)
          set CFLAGS=/DTIER0_DLL_EXPORT /DVSTDLIB_DLL_EXPORT /D_WINDOWS /DWIN32 /D_CRT_SECURE_NO_WARNINGS
          set CXXFLAGS=/DTIER0_DLL_EXPORT /DVSTDLIB_DLL_EXPORT /D_WINDOWS /DWIN32 /D_CRT_SECURE_NO_WARNINGS
          set LDFLAGS=/SUBSYSTEM:WINDOWS,10.0
          
          python waf build -p

      - name: Copy SDL2 for Convenience
        if: always()
        run: |
          if exist SDL2\lib\x64\SDL2.dll copy SDL2\lib\x64\SDL2.dll build\

      - name: Upload Full Build Folder
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: SourceEngine-Full-Build
          path: build/
          
