name: Build Portal ARM64 (Docker Method)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: arm64

      - name: Build in ARM64 Container
        run: |
          docker run --rm --platform linux/arm64 \
            -v ${{ github.workspace }}:/workspace \
            -w /workspace \
            arm64v8/ubuntu:24.04 /bin/bash -c "
              export DEBIAN_FRONTEND=noninteractive && \
              apt-get update && \
              apt-get install -y python3 build-essential pkg-config \
                libsdl2-dev libopenal-dev libjpeg-dev \
                libpng-dev libtiff-dev libwebp-dev \
                libfreetype6-dev libfontconfig1-dev \
                libcurl4-openssl-dev zlib1g-dev libbz2-dev \
                libglu1-mesa-dev libgl1-mesa-dev libx11-dev \
                libxext-dev libxi-dev libxrandr-dev \
                libxrender-dev libxcursor-dev && \
              python3 waf configure -T release --build-games=portal --disable-warns && \
              python3 waf build -p
            "

      - name: Prepare and Upload Package
        run: |
          mkdir -p out
          find build -type f \( -executable -o -name "*.so" \) | xargs -I {} cp {} out/
          tar -czvf portal_arm64.tar.gz out/

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: Portal-ARM64-Docker
          path: portal_arm64.tar.gz
